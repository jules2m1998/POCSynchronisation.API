<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="POCSync.MAUI.Views.SynchronisationPage"
             xmlns:viewmodel="clr-namespace:POCSync.MAUI.ViewModels"
             x:DataType="viewmodel:SynchronisationViewModel"
             xmlns:modelLocal="clr-namespace:POCSync.MAUI.Models"
             Title="SynchronisationPage">
    
    <ScrollView>
        <VerticalStackLayout Spacing="10" Padding="20">


            <Button 
                    Text="Start synchronisation" 
                    Command="{Binding SynchroniseCommand}"
                    IsEnabled="{Binding IsNotBusy}"
                    IsVisible="{Binding IsNotInitialisation}"
                    HorizontalOptions="Center"
                    Margin="8"/>
            <VerticalStackLayout IsVisible="{Binding IsThereSomethingToSync}">
                <Border
                    Stroke="{AppThemeBinding Light=Gray, Dark=DarkGray}"
                    StrokeShape="RoundRectangle 8"
                    Padding="15"
                    Margin="10"
                    BackgroundColor="{AppThemeBinding Light=White, Dark=#222}"
                    IsVisible="{Binding IsNotInitialisation}"
                >

                    <VerticalStackLayout Spacing="10">
                        <Label Text="📋 Rapport de synchronisation"
                           FontSize="18"
                           FontAttributes="Bold"
                           TextColor="{AppThemeBinding Light=Black, Dark=White}" />

                        <Grid ColumnDefinitions="*,Auto" RowDefinitions="Auto,Auto">
                            <Label Text="🕒 Action a synchroniser:"
                               Grid.Row="0" Grid.Column="0"
                               FontSize="16" />
                            <Label Text="{Binding CountDataToSync}"
                               Grid.Row="0" Grid.Column="1"
                               FontSize="16"
                               FontAttributes="Bold" />

                            <Label Text="🕒 Document a synchrroniser:"
                               Grid.Row="1" Grid.Column="0"
                               FontSize="16" />
                            <Label Text="{Binding CountDocToSync}"
                               Grid.Row="1" Grid.Column="1"
                               FontSize="16"
                               FontAttributes="Bold" />
                        </Grid>
                    </VerticalStackLayout>
                </Border>

                <Label 
                    Text="{Binding ProgressMessage}" 
                    FontSize="16"
                    FontAttributes="Bold"
                    HorizontalOptions="Start"
                    IsVisible="{Binding IsBusy}"/>

                <Label 
                    Text="{Binding ProgressTitle}" 
                    HorizontalOptions="Center" />

                <ProgressBar 
                    x:Name="MyProgressBar"
                    Progress="{Binding CurrentProgress}"
                    ProgressColor="Blue"
                    HorizontalOptions="Fill"
                    IsVisible="{Binding IsBusy}"/>

                <Button 
                    Text="Start initialisation" 
                    Command="{Binding RetrieveCommand}"
                    IsEnabled="{Binding IsNotBusy}"
                    IsVisible="{Binding IsInitialisation}"
                    HorizontalOptions="Center"
                    Margin="8"/>

                <Label 
                    Text="{Binding StoredEventJson}" 
                    HorizontalOptions="Center" />


            </VerticalStackLayout>

            <!-- Fallback when no documents to sync -->
            <Label Text="✨ Aucun donnee à synchroniser pour le moment."
                IsVisible="False"
                FontSize="16"
                FontAttributes="Italic"
                TextColor="Gray"
                HorizontalOptions="Center"
            >
                <Label.Triggers>
                    <DataTrigger TargetType="Label"
                         Binding="{Binding IsThereSomethingToSync}"
                         Value="False"
            >
                        <Setter Property="IsVisible" Value="True"/>
                    </DataTrigger>
                </Label.Triggers>
            </Label>
            <Button 
                Text="Ok"
                IsVisible="{Binding IsInitialised}"
                HorizontalOptions="Center"
                Margin="8"
                Command="{Binding ReloadPageCommand}"
            />
            
            <CollectionView
                ItemsSource="{Binding SynchroSteps}"
                SelectionMode="None"
                Margin="10"
            >
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="modelLocal:SynchroStep">
                        <Border 
                            StrokeThickness="1" 
                            StrokeShape="RoundRectangle 8"
                            Stroke="{AppThemeBinding Light=LightGray, Dark=DimGray}"
                            Padding="10"
                            Margin="0,5"
                        >
                            <Border.Triggers>
                                <DataTrigger TargetType="Border" Binding="{Binding IsError}" Value="True">
                                    <Setter Property="Stroke" Value="Red" />
                                </DataTrigger>
                            </Border.Triggers>

                            <Grid RowDefinitions="Auto,Auto,Auto" ColumnDefinitions="*,Auto" ColumnSpacing="10">

                                <!-- Step and Description on the left (col 0, row 0) -->
                                <StackLayout Grid.Row="0" Grid.Column="0" Spacing="2">
                                    <Label Text="{Binding Step}" FontAttributes="Bold" FontSize="20" />
                                    <Label Text="{Binding Description}" FontSize="14" />
                                </StackLayout>

                                <!-- Check icon on the right (col 1, row 0) -->
                                <Label 
                                    Grid.Row="0" Grid.Column="1"
                                    Text="&#xf058;" 
                                    FontFamily="FontAwesomeSolid"
                                    FontSize="30"
                                    TextColor="Green"
                                    VerticalOptions="Center"
                                    IsVisible="{Binding IsSuccess}"
                                />
                                <Label 
                                    Grid.Row="0" Grid.Column="1"
                                    Text="&#xf057;" 
                                    FontFamily="FontAwesomeSolid"
                                    FontSize="30"
                                    TextColor="Red"
                                    VerticalOptions="Center"
                                    IsVisible="{Binding IsError}"
                                />


                                <!-- Error section if any -->
                                <VerticalStackLayout 
                                    Grid.Row="2" Grid.ColumnSpan="2" 
                                    Margin="0,10,0,0"
                                    BackgroundColor="#ffe6e6"
                                    Padding="8"
                                    Spacing="5"
                                    IsVisible="{Binding HasErrors}"
                                >

                                    <Label 
                                        Text="⚠️ Erreurs :"
                                        TextColor="DarkRed"
                                        FontAttributes="Bold"
                                        FontSize="14" 
                                    />

                                    <CollectionView 
                                        ItemsSource="{Binding Errors}" 
                                        SelectionMode="None"
                                        Margin="0"
                                    >
                                        <CollectionView.ItemsLayout>
                                            <LinearItemsLayout Orientation="Vertical"/>
                                        </CollectionView.ItemsLayout>
                                        <CollectionView.ItemTemplate>
                                            <DataTemplate x:DataType="{x:Type x:String}">
                                                <Label 
                                                    Text="{Binding}"
                                                    FontSize="13"
                                                    TextColor="DarkRed"
                                                    Margin="10,2,0,0"
                                                />
                                            </DataTemplate>
                                        </CollectionView.ItemTemplate>
                                    </CollectionView>
                                </VerticalStackLayout>


                                <!-- Progress bar full width (row 1 spans both columns) -->
                                <ProgressBar 
                                    Grid.Row="1" Grid.ColumnSpan="2"
                                    Progress="{Binding Progress}"
                                    ProgressColor="Blue"
                                    Margin="0,10,0,0"
                                    HorizontalOptions="Fill">

                                    <ProgressBar.Triggers>
                                        <DataTrigger TargetType="ProgressBar" Binding="{Binding IsCompleted}" Value="True">
                                            <Setter Property="IsVisible" Value="False" />
                                        </DataTrigger>
                                    </ProgressBar.Triggers>
                                </ProgressBar>
                            </Grid>

                        </Border>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>

            <VerticalStackLayout
                Padding="20"
                Spacing="15"
                BackgroundColor="{AppThemeBinding Light=White, Dark=#1E1E1E}"
                IsVisible="{Binding Report.Isvisible}"
            >

                <!-- Events Section -->
                <Border StrokeThickness="1"
                    Stroke="LightBlue"
                    Background="#E3F2FD"
                    StrokeShape="RoundRectangle 12,12,12,12"
                    Padding="12" 
                    IsVisible="{Binding IsNotInitialisation}">
                    <VerticalStackLayout Spacing="5">
                        <Label Text="📦 Événements à synchroniser" FontAttributes="Bold" FontSize="16" />
                        <HorizontalStackLayout Spacing="10">
                            <Label Text="À synchroniser :" FontAttributes="Bold"/>
                            <Label Text="{Binding Report.TotalEventToSync}" />
                        </HorizontalStackLayout>
                        <HorizontalStackLayout Spacing="10">
                            <Label Text="Synchronisés :" FontAttributes="Bold"/>
                            <Label Text="{Binding Report.TotalEventSynced}" />
                        </HorizontalStackLayout>
                    </VerticalStackLayout>
                </Border>

                <!-- Events to Apply Section -->
                <Border StrokeThickness="1"
                    Stroke="LightGreen"
                    Background="#E8F5E9"
                    StrokeShape="RoundRectangle 12,12,12,12"
                    Padding="12"
                >
                    <VerticalStackLayout Spacing="5">
                        <Label Text="🛠️ Événements à appliquer" FontAttributes="Bold" FontSize="16" />
                        <HorizontalStackLayout Spacing="10">
                            <Label Text="À appliquer :" FontAttributes="Bold"/>
                            <Label Text="{Binding Report.TotalEventToApply}" />
                        </HorizontalStackLayout>
                        <HorizontalStackLayout Spacing="10">
                            <Label Text="Appliqués :" FontAttributes="Bold"/>
                            <Label Text="{Binding Report.TotalEventApplied}" />
                        </HorizontalStackLayout>
                    </VerticalStackLayout>
                </Border>

                <!-- Conflict Section -->
                <Border StrokeThickness="1" 
                    Stroke="Orange" 
                    Background="#FFF3E0" 
                    StrokeShape="RoundRectangle 12,12,12,12"
                    Padding="12"
                >
                    <VerticalStackLayout Spacing="5">
                        <Label Text="⚠️ Conflits détectés" FontAttributes="Bold" FontSize="16" />
                        <HorizontalStackLayout Spacing="10">
                            <Label Text="Nombre de conflits :" FontAttributes="Bold"/>
                            <Label Text="{Binding Report.TotalConflict}" />
                        </HorizontalStackLayout>
                    </VerticalStackLayout>
                </Border>

                <!-- Documents Section -->
                <Border StrokeThickness="1"
                    Stroke="HotPink"
                    Background="#FCE4EC"
                    StrokeShape="RoundRectangle 12,12,12,12"
                    Padding="12">
                    <VerticalStackLayout Spacing="5">
                        <Label Text="📄 Documents à synchroniser" FontAttributes="Bold" FontSize="16" />
                        <HorizontalStackLayout Spacing="10">
                            <Label Text="À synchroniser :" FontAttributes="Bold"/>
                            <Label Text="{Binding Report.TotalDocumentToSync}" />
                        </HorizontalStackLayout>
                        <HorizontalStackLayout Spacing="10">
                            <Label Text="Synchronisés :" FontAttributes="Bold"/>
                            <Label Text="{Binding Report.TotalDocumentSynced}" />
                        </HorizontalStackLayout>
                    </VerticalStackLayout>
                </Border>

            </VerticalStackLayout>

        </VerticalStackLayout>
    </ScrollView>
</ContentPage>